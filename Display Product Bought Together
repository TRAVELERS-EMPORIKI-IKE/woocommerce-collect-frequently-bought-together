// Hook into WooCommerce Single Product Page after product summary.
add_action('woocommerce_after_single_product_summary', 'show_related_products_based_on_purchase', 20);

function show_related_products_based_on_purchase() {
    global $product, $wpdb;

    $current_product_id = $product->get_id();
    $table_name = $wpdb->prefix . "customers_also_bought";

    // Get related products based on purchase data from our custom table.
    $related_products = $wpdb->get_results($wpdb->prepare(
        "SELECT also_bought_product_id FROM $table_name WHERE product_id = %d ORDER BY times_purchased DESC LIMIT 5",
        $current_product_id
    ));

    if (!$related_products) {
        return; // Exit if there are no related products for the current product.
    }

    echo '<div class="related-products-based-on-purchase">';
    echo '<h2>Customers who bought this also bought:</h2>';
    echo '<ul class="products">';

    foreach ($related_products as $related_product) {
        $_product = wc_get_product($related_product->also_bought_product_id);

        // Ensure the product exists and is visible.
        if (!$_product || !$_product->is_visible()) {
            continue;
        }

        $image_src = wp_get_attachment_image_src($_product->get_image_id(), 'woocommerce_thumbnail');
        $image_url = $image_src[0];

        echo '<li>';
        echo '<a href="' . esc_url(get_permalink($_product->get_id())) . '">' .
             '<img src="' . esc_url($image_url) . '" data-src="' . esc_url($image_url) . '" class="attachment-woocommerce_thumbnail size-woocommerce_thumbnail" alt="' . $_product->get_name() . '">' . 
             '<h2 class="woocommerce-loop-product__title">' . get_the_title($_product->get_id()) . '</h2>' .
             '</a>';
        echo woocommerce_template_loop_price();
        echo '</li>';
    }

    echo '</ul>';
    echo '</div>';
}
